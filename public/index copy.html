<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Collegiate Grill Photo Booth</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800;900&display=swap" rel="stylesheet">
    <style>
        /* Í∏∞Î≥∏ Î∞∞Í≤Ω ÏÑ§Ï†ï */
        body { margin: 0; overflow: hidden; background-color: #eeeeee; font-family: 'Montserrat', sans-serif; }
        
        /* Ï∫îÎ≤ÑÏä§ & ÎπÑÎîîÏò§ */
        #webcam { display: none; }
        #output_canvas { display: block; width: 100vw; height: 100vh; object-fit: contain; background-color: #d3d3d3; }

        /* =========================================
           [ÏàòÏ†ïÎê®] ÏÉÅÎã® Ìó§Îçî Ïª®ÌÖåÏù¥ÎÑà (2Îã® Íµ¨Ï°∞) 
           ========================================= */
        #header-container {
            position: absolute; top: 0; left: 0; width: 100%;
            display: flex; flex-direction: column;
            z-index: 300;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* 1Ï∏µ: CTA Î∞î (Touch Menu to Order) */
        #cta-bar {
            width: 100%; height: 5vh;
            background-color: #adacac; /* ÎÖ∏ÎûÄÏÉâ Í∞ïÏ°∞ */
            display: flex; align-items: center; justify-content: center;
            animation: pulseBar 2s infinite;
        }
        #cta-text {
            color: #000; font-size: 2vh; font-weight: 900; 
            text-transform: uppercase; letter-spacing: 1px;
            display: flex; align-items: center; gap: 1vh;
        }
        @keyframes pulseBar { 0%, 100% { background-color: #b8b6b6; } 50% { background-color: #c0c0be; } }

        /* 2Ï∏µ: Ïª®Ìä∏Î°§ Î∞î (Ï†úÎ™© + Î≤ÑÌäº) */
        #control-bar {
            width: 100%; height: 8vh;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(5px);
            display: flex; flex-direction: row; align-items: center; justify-content: space-between;
            padding: 0 3vw; box-sizing: border-box;
            border-bottom: 1px solid #ddd;
        }

        /* 2Ï∏µ ÏôºÏ™Ω: ÌòÑÏû¨ Î™®Îìú Ï†úÎ™© */
        #mode-title {
            color: #333; font-size: 1.4vh; font-weight: 600;
           
        }

        /* 2Ï∏µ Ïò§Î•∏Ï™Ω: Î≤ÑÌäº Í∑∏Î£π */
        #btn-group {
            display: flex; gap: 1vw;
        }
        .nav-btn {
            background: #ffffff;
            color: #555;
            padding: 1vh 1.5vw; 
            border-radius: 1vh; 
            border: 1px solid #ccc;
            font-size: 1.4vh; 
            font-weight: 700;
            cursor: pointer; 
            transition: 0.2s;
            display: flex; align-items: center; gap: 0.5vw;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .nav-btn:hover { background: #f9f9f9; transform: scale(1.05); }
        .nav-btn.active {
            background: #333; color: #fff; border-color: #333;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* Ïä§ÎßàÏùº UI */
        #smile-ui { display: none; width: 100%; height: 100%; }
        
        /* Ïä§ÏΩîÏñ¥ Î∞ïÏä§ */
        #score-box { 
            position: absolute; bottom: 3vh; left: 50%; transform: translateX(-50%); 
            width: 70%; 
            background: rgba(255, 255, 255, 0.95); 
            padding: 1.5vh 2.5vh; border-radius: 2vh; 
            border: 2px solid #ffc107;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(4px); 
            display: flex; flex-direction: column; align-items: center; z-index: 50;
        }
        .score-row { display: flex; justify-content: space-between; width: 100%; align-items: flex-end; margin-bottom: 0.5vh; }
        #score-label { color: #777; font-size: 1.3vh; font-weight: 700; }
        #score-value { color: #d32f2f; font-size: 4vh; font-weight: 900; line-height: 1; }
        #score-msg { color: #2e7d32; font-size: 1.8vh; font-weight: 800; }
        
        #graph-bg { width: 100%; height: 1.2vh; background-color: #eee; border-radius: 1vh; overflow: hidden; border: 1px solid #ddd; }
        #graph-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #ffc107, #ff5722); transition: width 0.1s linear; }

        /* Ìè¨ÌÜ†Î∂ÄÏä§ UI */
        #photo-ui { position: absolute; bottom: 5vh; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; z-index: 50; width: 100%; }
        .instruction { color: #333; margin-bottom: 1vh; text-shadow: 1px 1px 0px #fff; font-size: 2vh; font-weight: 800; }
        .hand-icon { font-size: 3vh; display: inline-block; margin-right: 5px; }
        #btn-shutter { 
            width: 10vh; height: 10vh; 
            background-color: #ffc107; border-radius: 50%; border: 0.5vh solid #fff; 
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
        #btn-shutter svg { width: 4vh; height: 4vh; fill: #333; }
        .btn-text { color: #333; font-size: 1.2vh; font-weight: 800; text-transform: uppercase; margin-top: 0.3vh; }

        /* Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ & Î°úÎî© */
        #countdown-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 15vh; color: #ffc107; font-weight: 900; text-shadow: 2px 2px 0px #000; display: none; pointer-events: none; z-index: 60; }
        #loading-bar-container { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); width: 20vw; height: 1.5vh; background: rgba(0,0,0,0.1); border-radius: 1vh; overflow: hidden; display: none; z-index: 55; border: 1px solid rgba(0,0,0,0.2); }
        #loading-bar { width: 0%; height: 100%; background-color: #ffc107; transition: width 0.1s linear; }

        /* Í≤∞Í≥ºÏ∞Ω */
        #result-modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(238,238,238,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 400; }
        #result-image-container { width: 85%; border: 1vh solid #fff; background: #ddd; margin-bottom: 2vh; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        #result-image { width: 100%; display: block; }
        #result-controls { display: flex; gap: 3vw; }
        .action-btn { 
            padding: 1.5vh 3vw; border-radius: 3vh; border: none; 
            font-size: 1.8vh; font-weight: bold; cursor: pointer; 
            display: flex; align-items: center; gap: 1vw; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-retake { background-color: #fff; color: #333; border: 1px solid #ccc; }
        .btn-save { background-color: #ffc107; color: #333; }

        /* QR Î™®Îã¨ */
        #qr-modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(238,238,238,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 500; }
        #qr-box { background: white; padding: 3vh; border-radius: 2vh; text-align: center; width: 80%; border: 1px solid #eee; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        #qr-image { width: 50vw; height: 50vw; max-width: 250px; max-height: 250px; display: block; margin: 0 auto 1vh auto; }
        #qr-text { font-size: 2vh; font-weight: bold; color: #333; margin-bottom: 1vh; }
        #btn-close-qr { background-color: #333; color: white; padding: 1vh 4vw; border-radius: 2vh; border: none; font-size: 1.8vh; font-weight: bold; cursor: pointer; }

        #kiosk-container { display: none !important; }
    </style>
</head>
<body>

<div id="header-container">
    <div id="cta-bar">
        <div id="cta-text">üëà TOUCH MENU TO ORDER</div>
    </div>
    <div id="control-bar">
        <div id="mode-title">Your Smile Makes This Place Happier </div>
        <div id="btn-group">
            <button class="nav-btn active" id="btn-mode-smile">üòÄ Smile Contest</button>
            <button class="nav-btn" id="btn-mode-photo">üì∏ Photo Booth</button>
        </div>
    </div>
</div>

<div id="kiosk-container"></div>

<div id="smile-ui">
    <div id="score-box">
        <div class="score-row">
            <div style="display:flex; flex-direction:column;">
                <span id="score-label">Smile üòä 80+ = Celebration üéâ</span>
                <div id="score-value">0</div>
            </div>
            <div id="score-msg">Ready?</div>
        </div>
        <div id="graph-bg"><div id="graph-bar"></div></div>
    </div>
</div>

<div id="photo-ui" style="display: none;">
    <div class="instruction"><span class="hand-icon">‚úã</span>Show palm (5s)</div>
    <button id="btn-shutter">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8.8c-1.77 0-3.2 1.43-3.2 3.2 0 1.77 1.43 3.2 3.2 3.2s3.2-1.43 3.2-3.2c0-1.77-1.43-3.2-3.2-3.2zm0 4.8c-.88 0-1.6-.72-1.6-1.6s.72-1.6 1.6-1.6 1.6.72 1.6 1.6-.72 1.6-1.6 1.6zM20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h4.05l1.83-2h4.24l1.83 2H20v12z"/></svg>
        <span class="btn-text">Snap</span>
    </button>
</div>

<div id="countdown-overlay"></div>
<div id="loading-bar-container"><div id="loading-bar"></div></div>
<video id="webcam" playsinline autoplay></video>
<canvas id="output_canvas"></canvas>

<div id="result-modal">
    <div id="result-image-container"><img id="result-image" src="" alt=""></div>
    <div id="result-controls">
        <button class="action-btn btn-retake" id="btn-retake">üîÑ Retake</button>
        <button class="action-btn btn-save" id="btn-save">üì± Save</button>
    </div>
</div>

<div id="qr-modal">
    <div id="qr-box">
        <div id="qr-text">Scan to Download</div>
        <img id="qr-image" src="" alt="QR Code">
        <div id="qr-status" style="margin-bottom:10px; color:#666; font-size:1.5vh;">Generating...</div>
        <button id="btn-close-qr">Close</button>
    </div>
</div>

<script type="module">
    import { GestureRecognizer, FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

    const IMGBB_API_KEY = "5a5ebc452e3711b0f1b9b6b0caea05ce"; 
    
    // Elements
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    const photoUI = document.getElementById('photo-ui');
    const smileUI = document.getElementById('smile-ui');
    const btnModePhoto = document.getElementById('btn-mode-photo');
    const btnModeSmile = document.getElementById('btn-mode-smile');
    const btnShutter = document.getElementById('btn-shutter');
    const btnRetake = document.getElementById('btn-retake');
    const btnSave = document.getElementById('btn-save');
    const scoreVal = document.getElementById('score-value');
    const scoreMsg = document.getElementById('score-msg');
    const graphBar = document.getElementById('graph-bar'); 
    const loadingContainer = document.getElementById('loading-bar-container');
    const loadingBar = document.getElementById('loading-bar');
    const countdownDiv = document.getElementById('countdown-overlay');
    const resultModal = document.getElementById('result-modal');
    const resultImage = document.getElementById('result-image');
    const qrModal = document.getElementById('qr-modal');
    const qrImage = document.getElementById('qr-image');
    const qrStatus = document.getElementById('qr-status');
    const btnCloseQr = document.getElementById('btn-close-qr');
    const modeTitle = document.getElementById('mode-title'); // Ï†úÎ™© Î≥ÄÍ≤ΩÏö©

    let gestureRecognizer, faceLandmarker;
    let running = false;
    let currentMode = 'smile'; 
    let countdownValue = 0;
    let palmHoldStartTime = 0;
    const PALM_HOLD_DURATION = 1500;
    let celebrated = false; 
    let countdownInterval = null;

    async function setupAI() {
        try {
            const filesetResolver = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            gestureRecognizer = await GestureRecognizer.createFromOptions(filesetResolver, {
                baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/gesture_recognizer/gesture_recognizer/float16/1/gesture_recognizer.task", delegate: "GPU" },
                runningMode: "VIDEO"
            });
            faceLandmarker = await FaceLandmarker.createFromOptions(filesetResolver, {
                baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task", delegate: "GPU" },
                outputFaceBlendshapes: true,
                runningMode: "VIDEO",
                numFaces: 1
            });
            startCamera();
        } catch (e) { console.error(e); }
    }

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720, facingMode: "user" } });
            video.srcObject = stream;
            video.onloadeddata = () => { 
                running = true; 
                switchMode('smile');
                requestAnimationFrame(loop); 
            };
        } catch (e) { alert("Camera Error"); }
    }

    async function loop() {
        if (!running) return;
        
        if (canvas.width !== window.innerWidth || canvas.height !== window.innerHeight) {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        }

        ctx.save();
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);

        const vRatio = video.videoWidth / video.videoHeight;
        const cRatio = canvas.width / canvas.height;
        let sW, sH, sX, sY;

        // ÌöåÏÉâ Î∞∞Í≤Ω Ï†ÅÏö©
        ctx.fillStyle = "#eeeeee"; 
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Zoom Out Î°úÏßÅ
        let renderH = canvas.height; 
        let renderW = renderH * vRatio; 
        
        renderH *= 0.8; 
        renderW *= 0.8;

        const offsetX = (canvas.width - renderW) / 2;
        const offsetY = (canvas.height - renderH) / 2;

        ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, offsetX, offsetY, renderW, renderH);
        
        ctx.restore();
        
        if (countdownValue === 0) {
            if (currentMode === 'photo') processPhotoBooth(performance.now());
            else if (currentMode === 'smile') processSmileContest(performance.now());
        }
        
        requestAnimationFrame(loop);
    }

    function processPhotoBooth(now) {
        if (!gestureRecognizer) return;
        const results = gestureRecognizer.recognizeForVideo(video, now);
        let palmDetected = false;
        if (results.gestures.length > 0) {
            const name = results.gestures[0][0].categoryName;
            const score = results.gestures[0][0].score;
            if (name === "Open_Palm" && score > 0.65) palmDetected = true;
        }
        if (palmDetected) {
            if (palmHoldStartTime === 0) { palmHoldStartTime = now; loadingContainer.style.display = 'block'; }
            const elapsedTime = now - palmHoldStartTime;
            const progress = Math.min((elapsedTime / PALM_HOLD_DURATION) * 100, 100);
            loadingBar.style.width = `${progress}%`;
            if (elapsedTime >= PALM_HOLD_DURATION) { 
                palmHoldStartTime = 0; 
                loadingContainer.style.display = 'none'; 
                startCountdown(); 
            }
        } else {
            palmHoldStartTime = 0; loadingContainer.style.display = 'none'; loadingBar.style.width = '0%';
        }
    }

    function processSmileContest(now) {
        if (!faceLandmarker) return;
        const results = faceLandmarker.detectForVideo(video, now);
        if (results.faceBlendshapes && results.faceBlendshapes.length > 0) {
            const shapes = results.faceBlendshapes[0].categories;
            const smileLeft = shapes.find(s => s.categoryName === 'mouthSmileLeft')?.score || 0;
            const smileRight = shapes.find(s => s.categoryName === 'mouthSmileRight')?.score || 0;
            let rawScore = ((smileLeft + smileRight) / 2) * 100;
            let score = Math.min(Math.round(rawScore * 1.5), 100); 
            
            scoreVal.innerText = score;
            graphBar.style.width = `${score}%`;

            if (score >= 80) {
                scoreMsg.innerText = "PERFECT!!";
                if (!celebrated) { 
                    fireIntenseConfetti(); 
                    celebrated = true; 
                    setTimeout(() => { celebrated = false; }, 3000); 
                }
            } else if (score >= 40) {
                scoreMsg.innerText = "Smile More :)";
            } else {
                scoreMsg.innerText = "Show me Smile!";
            }
        } else { 
            scoreVal.innerText = "0"; 
            graphBar.style.width = "0%";
            scoreMsg.innerText = "Face?"; 
        }
    }

    function fireIntenseConfetti() {
        var duration = 2000;
        var end = Date.now() + duration;

        (function frame() {
            confetti({
                particleCount: 5,
                angle: 60,
                spread: 55,
                origin: { x: 0 },
                zIndex: 999
            });
            confetti({
                particleCount: 5,
                angle: 120,
                spread: 55,
                origin: { x: 1 },
                zIndex: 999
            });

            if (Date.now() < end) {
                requestAnimationFrame(frame);
            }
        }());
    }

    function switchMode(mode) {
        currentMode = mode;
        photoUI.style.display = 'none'; smileUI.style.display = 'none'; 
        btnModePhoto.classList.remove('active'); btnModeSmile.classList.remove('active');
        
        // [ÏàòÏ†ï] Î™®ÎìúÏóê Îî∞Îùº ÏôºÏ™Ω Ï†úÎ™© Î≥ÄÍ≤Ω
        if (mode === 'photo') {
            photoUI.style.display = 'flex'; 
            btnModePhoto.classList.add('active');
            modeTitle.innerText = "You Look Good Today üòÑ Take a Photo!";
        } else if (mode === 'smile') {
            smileUI.style.display = 'block'; 
            btnModeSmile.classList.add('active');
            modeTitle.innerText = "Your Smile Makes This Place Happier üòä";
        } 
    }

    function startCountdown() {
        if (countdownValue > 0) return; 
        countdownValue = 5; 
        countdownDiv.style.display = 'block'; 
        countdownDiv.innerText = countdownValue;
        photoUI.style.display = 'none'; 
        
        if (countdownInterval) clearInterval(countdownInterval);

        countdownInterval = setInterval(() => {
            countdownValue--; 
            if (countdownValue > 0) {
                countdownDiv.innerText = countdownValue;
            } else {
                clearInterval(countdownInterval); 
                takePhoto();
            }
        }, 1000);
    }

    function takePhoto() {
        countdownDiv.style.display = 'none'; 
        resultImage.src = canvas.toDataURL('image/png'); 
        resultModal.style.display = 'flex';
    }

    function resetCamera() {
        resultModal.style.display = 'none'; qrModal.style.display = 'none';
        if (currentMode === 'photo') photoUI.style.display = 'flex';
        countdownValue = 0; 
        palmHoldStartTime = 0;
    }

    async function uploadAndShowQR() {
        if (IMGBB_API_KEY.length < 10) { alert("API KEY Check"); return; }
        resultModal.style.display = 'none'; qrModal.style.display = 'flex';
        qrStatus.innerText = "Uploading..."; qrImage.src = "";

        try {
            const base64Data = resultImage.src.split(',')[1];
            const formData = new FormData(); 
            formData.append("image", base64Data);
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
            const data = await response.json();
            
            if (data.success) {
                const uploadedImageUrl = data.data.url;
                qrStatus.innerText = "Scan to Download";
                qrImage.src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(uploadedImageUrl)}`;
            } else { qrStatus.innerText = "Upload Failed"; }
        } catch (error) { qrStatus.innerText = "Error"; }
    }

    btnModePhoto.addEventListener('click', () => switchMode('photo'));
    btnModeSmile.addEventListener('click', () => switchMode('smile'));
    btnShutter.addEventListener('click', startCountdown);
    btnRetake.addEventListener('click', resetCamera);
    btnSave.addEventListener('click', uploadAndShowQR);
    btnCloseQr.addEventListener('click', resetCamera);
    setupAI();
</script>
</body>
</html>